<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Leveling - Card Builder</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #fff;
            font-family: 'Lato', sans-serif;
            min-height: 100vh;
            padding: 2rem;
        }

        .builder-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 2rem;
            border: 1px solid #85acb9;
            box-shadow: 0 0 20px rgba(133, 172, 185, 0.3);
        }

        .builder-title {
            text-align: center;
            color: #85acb9;
            margin-bottom: 2rem;
            font-size: 2em;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(133, 172, 185, 0.5);
        }

        .form-group {
            margin-bottom: 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .form-group label {
            color: #85acb9;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .form-control {
            background: rgba(133, 172, 185, 0.1);
            border: 1px solid #85acb9;
            color: #fff;
            padding: 0.8rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background: rgba(133, 172, 185, 0.2);
            box-shadow: 0 0 15px rgba(133, 172, 185, 0.3);
            border-color: #85acb9;
            color: #fff;
        }

        .preview-section {
            margin-top: 0;
            padding: 1.25rem;
            border: 1px solid rgba(133, 172, 185, 0.75);
            background: rgba(0, 0, 0, 0.5);
        }

        .preview-title {
            color: #85acb9;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            font-size: 1.2em;
        }

        .preview-content {
            min-height: 340px;
        }

        .preview-card {
            border: 2px solid #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.35);
            padding: 2rem;
            position: relative;
            background: transparent;
        }

        .preview-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 30%, rgba(0, 0, 0, 0.75) 100%);
            pointer-events: none;
            z-index: 0;
        }

        .preview-card > * {
            position: relative;
            z-index: 1;
        }

        .sl-title-preview {
            color: #fff;
            letter-spacing: 3px;
            margin-bottom: 25px;
            text-shadow:
                0 0 5px var(--sl-accent, #85acb9),
                0 0 10px var(--sl-accent, #85acb9),
                0 0 20px var(--sl-accent, #85acb9),
                0 0 40px rgba(99, 170, 194, 0.8);
            font-size: 1.25em;
            -webkit-text-stroke: 1px #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-transform: uppercase;
        }

        .sl-title-preview span {
            border: 1px solid #fff;
            padding: 5px 10px;
        }

        .sl-title-preview .sl-exclamation-preview {
            position: relative;
            width: 40px;
            height: 40px;
            border: 2px solid #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #fff;
            text-shadow:
                0 0 5px var(--sl-accent, #85acb9),
                0 0 10px var(--sl-accent, #85acb9),
                0 0 20px var(--sl-accent, #85acb9);
            -webkit-text-stroke: 1px #fff;
        }

        .sl-title-preview .sl-exclamation-preview::after {
            content: "";
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 1px solid #fff;
            border-radius: 0;
        }

        .preview-muted {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95em;
        }

        .sl-highlight {
            color: #fff;
            font-weight: 800;
            text-shadow:
                0 0 7px #fff,
                0 0 10px #fff,
                0 0 21px #fff,
                0 0 42px var(--sl-accent, #85acb9),
                0 0 82px var(--sl-accent, #85acb9),
                0 0 92px var(--sl-accent, #85acb9),
                0 0 102px var(--sl-accent, #85acb9);
        }

        .sl-success {
            color: var(--sl-success, #00ff62);
            font-weight: 800;
            text-shadow:
                0 0 7px var(--sl-success, #00ff62),
                0 0 10px var(--sl-success, #00ff62),
                0 0 21px var(--sl-success, #00ff62),
                0 0 42px var(--sl-success, #00ff62);
        }

        .sl-danger {
            color: var(--sl-danger, #ff0000);
            font-weight: 800;
            text-shadow:
                0 0 7px var(--sl-danger, #ff0000),
                0 0 10px var(--sl-danger, #ff0000),
                0 0 21px var(--sl-danger, #ff0000),
                0 0 42px var(--sl-danger, #ff0000);
        }

        .builder-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 0.75rem;
        }

        .btn-secondary-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.35);
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 0.8rem 1rem;
            transition: all 0.3s ease;
        }

        .btn-secondary-outline:hover {
            border-color: #85acb9;
            color: #fff;
            box-shadow: 0 0 15px rgba(133, 172, 185, 0.25);
        }

        .btn-generate {
            background: transparent;
            border: 1px solid #85acb9;
            color: #85acb9;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 1rem 2rem;
            margin-top: 2rem;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn-generate:hover {
            background: rgba(133, 172, 185, 0.1);
            box-shadow: 0 0 20px rgba(133, 172, 185, 0.3);
            color: #fff;
        }

        .btn-generate::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(133, 172, 185, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: buttonGlow 2s linear infinite;
        }

        @keyframes buttonGlow {
            0% {
                transform: translateX(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) rotate(45deg);
            }
        }

        .preview-text {
            color: #fff;
            text-shadow: 0 0 7px #fff,
                        0 0 10px #fff,
                        0 0 21px #fff,
                        0 0 42px #85acb9,
                        0 0 82px #85acb9,
                        0 0 92px #85acb9,
                        0 0 102px #85acb9,
                        0 0 151px #85acb9;
        }

        .preview-date {
            color: #00ff62;
            text-shadow: 0 0 7px #00ff62,
                        0 0 10px #00ff62,
                        0 0 21px #00ff62,
                        0 0 42px #00ff62,
                        0 0 82px #00ff62,
                        0 0 92px #00ff62,
                        0 0 102px #00ff62,
                        0 0 151px #00ff62;
        }
        
        .page-selector {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #85acb9;
            background: rgba(0, 0, 0, 0.5);
        }

        .page-selector label {
            color: #85acb9;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            display: block;
        }

        .page-selector select {
            width: 100%;
            height: auto;
            background: rgba(133, 172, 185, 0.1);
            border: 1px solid #85acb9;
            color: #fff;
            padding: 0.8rem;
            margin-bottom: 1rem;
        }

        .page-selector select:focus {
            background: rgba(133, 172, 185, 0.2);
            box-shadow: 0 0 15px rgba(133, 172, 185, 0.3);
            outline: none;
        }

        .fields-container > div {
            display: none;
        }

        .fields-container > div.active {
            display: block;
        }

        /* Preview: show only the selected card */
        .preview-card > div {
            display: none;
        }

        .preview-card > div.active {
            display: block;
        }

        /* Dropdown readability */
        #pageSelect {
            font-size: 1.05rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: none;
            padding: 0.9rem;
        }

        #pageSelect option {
            background: #0b0b0b;
            color: #fff;
        }

        #linkContainer {
            display: none;
        }
    </style>
</head>
<body>
    <div class="builder-container">
        <h1 class="builder-title">Solo Leveling Card Builder 0.1.0</h1>
        
        <form id="builderForm">
            <div class="row">
                <div class="col-lg-6">
                    <div class="page-selector">
                        <label for="pageSelect">Select Card</label>
                        <select id="pageSelect" class="form-control">
                            <option value="index">Notification (Index)</option>
                            <option value="acceuil">Welcome / Valentine</option>
                            <option value="home">Reward</option>
                            <option value="quest">Quest</option>
                        </select>

                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="slAccent">Accent Color</label>
                                <input type="color" class="form-control" id="slAccent" value="#85acb9">
                            </div>
                            <div class="col-md-4">
                                <label for="slSuccess">Success Color</label>
                                <input type="color" class="form-control" id="slSuccess" value="#00ff62">
                            </div>
                            <div class="col-md-4">
                                <label for="slDanger">Danger Color</label>
                                <input type="color" class="form-control" id="slDanger" value="#ff0000">
                            </div>
                        </div>
                        <p class="preview-muted mt-2 mb-0">These colors are included in the share link and apply to supported parts of the cards.</p>
                    </div>

                    <div class="page-selector">
                        <label for="importLink">Load From Link (Optional)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="importLink" placeholder="Paste a #data= link here">
                            <div class="input-group-append">
                                <button class="btn btn-outline-info" type="button" id="btnLoadLink" style="border-color: #85acb9; color: #85acb9;">Load</button>
                            </div>
                        </div>
                        <div class="builder-actions">
                            <button type="button" class="btn-secondary-outline" id="btnReset">Reset</button>
                            <button type="button" class="btn-secondary-outline" id="btnSave">Save Draft</button>
                            <button type="button" class="btn-secondary-outline" id="btnClearDraft">Clear Draft</button>
                        </div>
                    </div>

                    <div class="fields-container">
                        <div id="indexFields" class="active">
                            <div class="form-group">
                                <label for="indexTitle">Title</label>
                                <input type="text" class="form-control" id="indexTitle" value="NOTIFICATION">
                            </div>

                            <div class="form-group">
                                <label for="indexLine1Prefix">Line 1 Prefix</label>
                                <input type="text" class="form-control" id="indexLine1Prefix" value="You heart will stop in">
                            </div>

                            <div class="form-group">
                                <label for="indexCountdownSeconds">Countdown Seconds</label>
                                <input type="number" class="form-control" id="indexCountdownSeconds" value="10" min="1" max="999">
                            </div>

                            <div class="form-group">
                                <label for="indexLine2">Line 2</label>
                                <input type="text" class="form-control" id="indexLine2" value="if you dont accept">
                            </div>

                            <div class="form-group">
                                <label for="indexPrompt">Prompt</label>
                                <input type="text" class="form-control" id="indexPrompt" value="Do you want to accept ?">
                            </div>

                            <div class="form-group">
                                <label for="indexYesText">Yes Button</label>
                                <input type="text" class="form-control" id="indexYesText" value="Yes">
                            </div>

                            <div class="form-group">
                                <label for="indexNoText">No Button</label>
                                <input type="text" class="form-control" id="indexNoText" value="No">
                            </div>

                            <div class="form-group">
                                <label for="indexDramaticText">Yes Reveal Text</label>
                                <input type="text" class="form-control" id="indexDramaticText" value="Courage of the weak acquired">
                            </div>
                        </div>

                        <div id="acceuilFields">
                            <div class="form-group">
                                <label for="acceuilTitle">Title</label>
                                <input type="text" class="form-control" id="acceuilTitle" value="NOTIFICATION">
                            </div>

                            <div class="form-group">
                                <label for="acceuilQuestion">Question</label>
                                <input type="text" class="form-control" id="acceuilQuestion" value="Will you be my valentine ?">
                            </div>

                            <div class="form-group">
                                <label for="acceuilPenaltyLabel">Penalty Label</label>
                                <input type="text" class="form-control" id="acceuilPenaltyLabel" value="Penalty">
                            </div>

                            <div class="form-group">
                                <label for="acceuilPenaltyValue">Penalty Value</label>
                                <input type="text" class="form-control" id="acceuilPenaltyValue" value="Death">
                            </div>

                            <div class="form-group">
                                <label for="acceuilPrompt">Prompt</label>
                                <input type="text" class="form-control" id="acceuilPrompt" value="Do you want to accept this quest ?">
                            </div>

                            <div class="form-group">
                                <label for="acceuilYesText">Yes Button</label>
                                <input type="text" class="form-control" id="acceuilYesText" value="Yes">
                            </div>

                            <div class="form-group">
                                <label for="acceuilNoText">No Button</label>
                                <input type="text" class="form-control" id="acceuilNoText" value="No">
                            </div>

                            <div class="form-group">
                                <label for="girlfriendName">Reveal Name (dramatic text)</label>
                                <input type="text" class="form-control" id="girlfriendName" value="Your Girlfriend name">
                            </div>
                        </div>

                        <div id="homeFields">
                            <div class="form-group">
                                <label for="homeTitle">Title</label>
                                <input type="text" class="form-control" id="homeTitle" value="NOTIFICATION">
                            </div>

                            <div class="form-group">
                                <label for="mainMessage">Main Message</label>
                                <input type="text" class="form-control" id="mainMessage" value="Congratulations, your are now">
                            </div>

                            <div class="form-group">
                                <label for="highlightedText">Highlighted Text</label>
                                <input type="text" class="form-control" id="highlightedText" value="MINE">
                            </div>

                            <div class="form-group">
                                <label for="rewardLabel">Reward Label</label>
                                <input type="text" class="form-control" id="rewardLabel" value="Rewards">
                            </div>

                            <div class="form-group">
                                <label for="rewardDate">Reward Date</label>
                                <input type="text" class="form-control" id="rewardDate" value="Date">
                            </div>

                            <div class="form-group">
                                <label for="homeAcceptText">Bottom Text</label>
                                <input type="text" class="form-control" id="homeAcceptText" value="Accept your reward">
                            </div>

                            <div class="form-group">
                                <label for="homeOkText">Button Text</label>
                                <input type="text" class="form-control" id="homeOkText" value="OK">
                            </div>

                            <div class="form-group">
                                <label for="homeDramaticText">Reveal Text</label>
                                <input type="text" class="form-control" id="homeDramaticText" value="Reward Acquired">
                            </div>
                        </div>

                        <div id="questFields">
                            <div class="form-group">
                                <label for="questTitle">Title</label>
                                <input type="text" class="form-control" id="questTitle" value="QUEST INFO">
                            </div>

                            <div class="form-group">
                                <label for="questHeader">Quest Header</label>
                                <input type="text" class="form-control" id="questHeader" value="Dail Quest">
                            </div>

                            <div class="form-group">
                                <label for="questName">Quest Name</label>
                                <input type="text" class="form-control" id="questName" value="Test of Love has arrived">
                            </div>

                            <div class="form-group">
                                <label for="questGoalsTitle">Goals Title</label>
                                <input type="text" class="form-control" id="questGoalsTitle" value="GOALS">
                            </div>

                            <div class="form-group">
                                <label for="questTask">Task 1</label>
                                <input type="text" class="form-control" id="questTask" value="Go to a Restaurant">
                            </div>

                            <div class="form-group">
                                <label for="questTaskCount">Task 1 Count</label>
                                <input type="text" class="form-control" id="questTaskCount" value="[0/1]">
                            </div>

                            <div class="form-group">
                                <label for="questTask2">Task 2</label>
                                <input type="text" class="form-control" id="questTask2" value="Netflix and Chill">
                            </div>

                            <div class="form-group">
                                <label for="questTask2Count">Task 2 Count</label>
                                <input type="text" class="form-control" id="questTask2Count" value="[0/69]">
                            </div>

                            <div class="form-group">
                                <label for="questWarning">Warning Message</label>
                                <input type="text" class="form-control" id="questWarning" value="WARNING: Failure will result in your separation.">
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn-generate" id="btnGenerate">Generate Share Link</button>

                    <div class="form-group" style="margin-top: 20px;" id="linkContainer">
                        <label>Share this link:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="shareableLink" readonly>
                            <div class="input-group-append">
                                <button class="btn btn-outline-info" type="button" id="btnCopy" style="border-color: #85acb9; color: #85acb9;">Copy</button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <p class="text-muted">Quick previews:</p>
                            <div class="btn-group flex-wrap">
                                <button type="button" class="btn btn-outline-info" data-preview="index" style="border-color: #85acb9; color: #85acb9;">Index</button>
                                <button type="button" class="btn btn-outline-info" data-preview="acceuil" style="border-color: #85acb9; color: #85acb9;">Welcome</button>
                                <button type="button" class="btn btn-outline-info" data-preview="home" style="border-color: #85acb9; color: #85acb9;">Reward</button>
                                <button type="button" class="btn btn-outline-info" data-preview="quest" style="border-color: #85acb9; color: #85acb9;">Quest</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mt-4 mt-lg-0">
                    <div class="preview-section">
                        <h3 class="preview-title">Live Preview</h3>
                        <div class="preview-content">
                            <div class="preview-card">
                                <div id="indexPreview" class="active">
                                    <div class="sl-title-preview">
                                        <span class="sl-exclamation-preview">!</span>
                                        <span id="previewIndexTitle"></span>
                                    </div>
                                    <p>
                                        <span id="previewIndexLine1Prefix"></span>
                                        <span id="previewIndexCountdown" class="sl-danger"></span>
                                    </p>
                                    <p id="previewIndexLine2"></p>
                                    <p id="previewIndexPrompt"></p>
                                    <p class="preview-muted mb-0">(Yes reveal: <span id="previewIndexDramatic"></span>)</p>
                                </div>

                                <div id="acceuilPreview">
                                    <div class="sl-title-preview">
                                        <span class="sl-exclamation-preview">!</span>
                                        <span id="previewAcceuilTitle"></span>
                                    </div>
                                    <p id="previewAcceuilQuestion"></p>
                                    <p>
                                        [<span id="previewAcceuilPenaltyLabel"></span>: <span id="previewAcceuilPenaltyValue" class="sl-danger"></span>]
                                    </p>
                                    <p id="previewAcceuilPrompt"></p>
                                    <p class="preview-muted mb-0">(Reveal: <span id="previewGirlfriendName"></span>)</p>
                                </div>

                                <div id="homePreview">
                                    <div class="sl-title-preview">
                                        <span class="sl-exclamation-preview">!</span>
                                        <span id="previewHomeTitle"></span>
                                    </div>
                                    <p>
                                        <span id="previewMainText"></span>
                                        <span id="previewHighlight" class="sl-highlight"></span>
                                    </p>
                                    <p>
                                        [<span id="previewRewardLabel"></span>: <span id="previewDate" class="sl-success"></span>]
                                    </p>
                                    <p id="previewHomeAcceptText"></p>
                                    <p class="preview-muted mb-0">(Reveal: <span id="previewHomeDramatic"></span>)</p>
                                </div>

                                <div id="questPreview">
                                    <div class="sl-title-preview">
                                        <span class="sl-exclamation-preview">!</span>
                                        <span id="previewQuestTitle"></span>
                                    </div>
                                    <p>
                                        [<span id="previewQuestHeader"></span>: <span id="previewQuestName" class="sl-highlight"></span>]
                                    </p>
                                    <p class="preview-muted" style="letter-spacing: 2px; text-transform: uppercase;">— <span id="previewQuestGoalsTitle"></span> —</p>
                                    <p>
                                        <span id="previewQuestTask"></span>
                                        <span class="preview-muted"> </span>
                                        <span id="previewQuestTaskCount" class="preview-muted"></span>
                                    </p>
                                    <p>
                                        <span id="previewQuestTask2"></span>
                                        <span class="preview-muted"> </span>
                                        <span id="previewQuestTask2Count" class="preview-muted"></span>
                                    </p>
                                    <p id="previewQuestWarning" class="sl-danger"></p>
                                </div>
                            </div>
                        </div>
                        <p class="preview-muted mt-3 mb-0">Preview is approximate (the actual pages include more effects/particles).</p>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        const DRAFT_KEY = 'sl_builder_draft_v1';

        const DEFAULTS = {
            slAccent: '#85acb9',
            slSuccess: '#00ff62',
            slDanger: '#ff0000',

            indexTitle: 'NOTIFICATION',
            indexLine1Prefix: 'You heart will stop in',
            indexCountdownSeconds: 10,
            indexLine2: 'if you dont accept',
            indexPrompt: 'Do you want to accept ?',
            indexYesText: 'Yes',
            indexNoText: 'No',
            indexDramaticText: 'Courage of the weak acquired',

            acceuilTitle: 'NOTIFICATION',
            acceuilQuestion: 'Will you be my valentine ?',
            acceuilPenaltyLabel: 'Penalty',
            acceuilPenaltyValue: 'Death',
            acceuilPrompt: 'Do you want to accept this quest ?',
            acceuilYesText: 'Yes',
            acceuilNoText: 'No',
            girlfriendName: 'Your Girlfriend name',

            homeTitle: 'NOTIFICATION',
            mainMessage: 'Congratulations, your are now',
            highlightedText: 'MINE',
            rewardLabel: 'Rewards',
            rewardDate: 'Date',
            homeAcceptText: 'Accept your reward',
            homeOkText: 'OK',
            homeDramaticText: 'Reward Acquired',

            questTitle: 'QUEST INFO',
            questHeader: 'Dail Quest',
            questName: 'Test of Love has arrived',
            questGoalsTitle: 'GOALS',
            questTask: 'Go to a Restaurant',
            questTaskCount: '[0/1]',
            questTask2: 'Netflix and Chill',
            questTask2Count: '[0/69]',
            questWarning: 'WARNING: Failure will result in your separation.'
        };

        function encodeData(data) {
            const json = JSON.stringify(data);
            return btoa(unescape(encodeURIComponent(json)));
        }

        function decodeData(encoded) {
            try {
                return JSON.parse(decodeURIComponent(escape(atob(encoded))));
            } catch (e) {
                // Backwards compatibility for older links
                return JSON.parse(atob(encoded));
            }
        }

        function readForm() {
            const data = {};
            Object.keys(DEFAULTS).forEach((key) => {
                const el = document.getElementById(key);
                if (!el) return;
                if (el.type === 'number') {
                    data[key] = Number(el.value);
                    return;
                }
                data[key] = el.value;
            });
            return data;
        }

        function writeForm(data) {
            Object.keys(DEFAULTS).forEach((key) => {
                const el = document.getElementById(key);
                if (!el) return;
                const value = data[key] ?? DEFAULTS[key];
                el.value = String(value);
            });
        }

        function applyThemeVars(data) {
            document.documentElement.style.setProperty('--sl-accent', data.slAccent || DEFAULTS.slAccent);
            document.documentElement.style.setProperty('--sl-success', data.slSuccess || DEFAULTS.slSuccess);
            document.documentElement.style.setProperty('--sl-danger', data.slDanger || DEFAULTS.slDanger);
        }

        function setActiveSection(selectedPage) {
            document.querySelectorAll('.fields-container > div').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.preview-card > div').forEach(div => div.classList.remove('active'));

            const fields = document.getElementById(selectedPage + 'Fields');
            const preview = document.getElementById(selectedPage + 'Preview');
            if (fields) fields.classList.add('active');
            if (preview) preview.classList.add('active');
        }

        function updatePreview() {
            const selectedPage = document.getElementById('pageSelect').value;
            const data = readForm();
            applyThemeVars(data);
            setActiveSection(selectedPage);

            // Index preview
            document.getElementById('previewIndexTitle').textContent = data.indexTitle;
            document.getElementById('previewIndexLine1Prefix').textContent = (data.indexLine1Prefix || '') + ' ';
            document.getElementById('previewIndexCountdown').textContent = `${Number(data.indexCountdownSeconds || 0)} seconds`;
            document.getElementById('previewIndexLine2').textContent = data.indexLine2;
            document.getElementById('previewIndexPrompt').textContent = data.indexPrompt;
            document.getElementById('previewIndexDramatic').textContent = data.indexDramaticText;

            // Acceuil preview
            document.getElementById('previewAcceuilTitle').textContent = data.acceuilTitle;
            document.getElementById('previewAcceuilQuestion').textContent = data.acceuilQuestion;
            document.getElementById('previewAcceuilPenaltyLabel').textContent = data.acceuilPenaltyLabel;
            document.getElementById('previewAcceuilPenaltyValue').textContent = data.acceuilPenaltyValue;
            document.getElementById('previewAcceuilPrompt').textContent = data.acceuilPrompt;
            document.getElementById('previewGirlfriendName').textContent = data.girlfriendName;

            // Home preview
            document.getElementById('previewHomeTitle').textContent = data.homeTitle;
            document.getElementById('previewMainText').textContent = (data.mainMessage || '') + ' ';
            document.getElementById('previewHighlight').textContent = data.highlightedText;
            document.getElementById('previewRewardLabel').textContent = data.rewardLabel;
            document.getElementById('previewDate').textContent = data.rewardDate;
            document.getElementById('previewHomeAcceptText').textContent = data.homeAcceptText;
            document.getElementById('previewHomeDramatic').textContent = data.homeDramaticText;

            // Quest preview
            document.getElementById('previewQuestTitle').textContent = data.questTitle;
            document.getElementById('previewQuestHeader').textContent = data.questHeader;
            document.getElementById('previewQuestName').textContent = data.questName;
            document.getElementById('previewQuestGoalsTitle').textContent = data.questGoalsTitle;
            document.getElementById('previewQuestTask').textContent = data.questTask;
            document.getElementById('previewQuestTaskCount').textContent = data.questTaskCount;
            document.getElementById('previewQuestTask2').textContent = data.questTask2;
            document.getElementById('previewQuestTask2Count').textContent = data.questTask2Count;
            document.getElementById('previewQuestWarning').textContent = data.questWarning;
        }

        function buildShareLink() {
            const data = readForm();
            const encodedData = encodeData(data);
            const url = new URL('index.html', window.location.href);
            url.hash = 'data=' + encodedData;
            return url.toString();
        }

        function generatePage() {
            const shareableLink = buildShareLink();
            document.getElementById('linkContainer').style.display = 'block';
            document.getElementById('shareableLink').value = shareableLink;
        }

        async function copyLink() {
            const value = document.getElementById('shareableLink').value;
            if (!value) return;

            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(value);
                } else {
                    const linkInput = document.getElementById('shareableLink');
                    linkInput.focus();
                    linkInput.select();
                    document.execCommand('copy');
                }

                const copyBtn = document.getElementById('btnCopy');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = originalText, 1500);
            } catch (e) {
                console.error('Copy failed:', e);
            }
        }

        function previewPage(page) {
            const data = readForm();
            const encodedData = encodeData(data);
            const url = new URL(page + '.html', window.location.href);
            url.hash = 'data=' + encodedData;
            window.open(url.toString(), '_blank');
        }

        function resetForm() {
            writeForm(DEFAULTS);
            updatePreview();
        }

        function saveDraft() {
            localStorage.setItem(DRAFT_KEY, JSON.stringify(readForm()));
        }

        function loadDraft() {
            const raw = localStorage.getItem(DRAFT_KEY);
            if (!raw) return null;
            try {
                return JSON.parse(raw);
            } catch {
                return null;
            }
        }

        function clearDraft() {
            localStorage.removeItem(DRAFT_KEY);
        }

        function loadFromLink(input) {
            if (!input) return;
            const match = input.match(/#data=([^&]+)/i);
            if (!match) return;
            try {
                const data = decodeData(match[1]);
                // Merge with defaults to ensure new fields appear
                writeForm({ ...DEFAULTS, ...data });
                updatePreview();
            } catch (e) {
                console.error('Failed to load link:', e);
            }
        }

        // Events
        document.getElementById('pageSelect').addEventListener('change', updatePreview);
        document.getElementById('btnGenerate').addEventListener('click', generatePage);
        document.getElementById('btnCopy').addEventListener('click', copyLink);

        document.querySelectorAll('[data-preview]').forEach((btn) => {
            btn.addEventListener('click', () => previewPage(btn.dataset.preview));
        });

        document.getElementById('btnReset').addEventListener('click', resetForm);
        document.getElementById('btnSave').addEventListener('click', saveDraft);
        document.getElementById('btnClearDraft').addEventListener('click', () => {
            clearDraft();
            resetForm();
        });
        document.getElementById('btnLoadLink').addEventListener('click', () => loadFromLink(document.getElementById('importLink').value));

        // Live update
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('input', updatePreview);
        });

        // Init
        const draft = loadDraft();
        if (draft) {
            writeForm({ ...DEFAULTS, ...draft });
        } else {
            writeForm(DEFAULTS);
        }
        updatePreview();
    </script>
</body>
</html>